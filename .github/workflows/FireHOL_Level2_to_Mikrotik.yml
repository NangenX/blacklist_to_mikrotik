name: FireHOL_Level2

on:
  schedule:
    - cron: '0 */6 * * *' # 每6个小时运行
  workflow_dispatch:

jobs:
  update-blacklist:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Download FireHOL Level2 blacklist
      run: |
        curl -fsSL -o level2.txt https://iplists.firehol.org/files/firehol_level2.netset
        sed '/^#/d' level2.txt > level2_no_comments.txt
        
    - name: Convert blacklist to Mikrotik format
      run: |
        echo "/ip firewall address-list" > FireHOL_Level2.rsc
        awk '{ sub(/\r$/, ""); if (NF) print "add list=blocklist address=" $1 " comment=\"Blocklist2\"" }' level2_no_comments.txt >> FireHOL_Level2.rsc

    - name: Force Push to Keep History Clean
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "github-action@users.noreply.github.com"
        
        # 关键操作：使用 --amend 修改上一次提交，而不是创建新提交
        # 或者重新初始化一个孤立分支推上去
        git add FireHOL_Level2.rsc
        
        # 即使文件没变也提交，确保时间戳更新
        git commit --allow-empty -m "Update FireHOL Level2: $(date -u)"
        
        # 强制推送覆盖远程 main 分支
        git push origin main --force

    - name: Delete Old Release
      uses: ophub/delete-releases-workflows@main
      with:
        delete_tags: true
        gh_token: ${{ secrets.GITHUB_TOKEN }}
        delete_releases: true
        releases_keep_latest: 0
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: FireHOL-Level2-Latest
        name: FireHOL Level2 Update
        files: |
          FireHOL_Level2.rsc
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Delete old workflow runs
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        repository: ${{ github.repository }}
        retain_days: 7
        keep_minimum_runs: 6
